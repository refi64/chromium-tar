Name: R8
URL: https://r8.googlesource.com/r8
Revision: 1d0cad3ec27fc88a1ca4ffc4d3d4d5d0b3f80f5b
Version: Unknown
License: BSD 3-Clause
License File: NOT_SHIPPED
Security Critical: no

Description:
lib/r8.jar
 - Contains R8 (proguard replacement) as well as D8 (dexer).
desugar_jdk_libs.json
 - Configuration for Java library desugaring.
 - Taken from
   //third_party/android_deps/libs/com_android_tools_desugar_jdk_libs_configuration/
   inside the jar file, in META-INF/desugar/d8/desugar.json. License is also BSD
   3-Clause (the r8 version).

R8 is a proguard-like optimizer that also has the ability to dex.

Local Modifications:
* Refer to commit descriptions within "patches" directory.
  * Plus: https://r8-review.googlesource.com/c/r8/+/56708
* Added "playground" directory for quick "how does this optimize" tests.
* Removed references to ConcurrentHashMap and TimeZone#getTimeZone in desugar_jdk_libs.json.
* Cherry-pick fix for M89: 6d54693bc5725b8d1ce362368b1b1ad87f92e74a

Update Instructions:
# Download R8:
git clone https://r8.googlesource.com/r8
cd r8
# Find latest tag:
git fetch origin --tags
git tag -l  # Often unnecessary as output from the fetch includes recent tags.
git checkout $TAG  # e.g. 2.2.9-dev

# Apply patches:
git checkout -b my_branch
git am $CHROMIUM_SRC/third_party/r8/patches/*.patch
# Build:
tools/gradle.py r8
# Shrink (improves r8/d8 launch time):
java -jar build/libs/r8.jar --debug --classfile --output r8.jar \
    --lib $CHROMIUM_SRC/third_party/jdk/current --pg-conf src/main/keep.txt \
    --no-minification --no-desugaring build/libs/r8.jar
mv $CHROMIUM_SRC/third_party/r8/lib/r8.jar{,.bak}
cp r8.jar $CHROMIUM_SRC/third_party/r8/lib/r8.jar

# Create patches if conflicts / new patches. Change number if expecting
# different amount of patches:
git format-patch -3 -o $CHROMIUM_SRC/third_party/r8/patches

# Upload to CIPD:
cd $CHROMIUM_SRC/third_party/r8
cipd create --pkg-def cipd.yaml # Make note of the instance ID

# Update backported methods list:
cd $CHROMIUM_SRC
java -cp third_party/r8/lib/r8.jar com.android.tools.r8.BackportedMethodList --min-api 16 > third_party/r8/backported_methods.txt

# Manually update:
* README.chromium (version number via "java -cp lib/r8.jar com.android.tools.r8.R8 --version")
* //DEPS (instance ID output by cipd create)

Update instructions for desugar_jdk_libs.json:
* Find desugar.json as described above and copy to desugar_jdk_libs.json.
* Remove all mentions of ConcurrentHashMap and TimeZone#getTimeZone and remove trailing commas.

How to file bugs against R8:
* Copy & paste the failing ninja command (starts with proguard.py), and add --dump-inputs.
* File bug at go/r8bug
* Things to include (use discretion if some are not relevant):
  * src revision bug reproduces at
  * Repro steps (gn gen & autoninja commands)
    * Prefer enable_chrome_android_internal=false
  * The r8inputs.zip from --dump-inputs
  * Any relevant dexdump analysis
